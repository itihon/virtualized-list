<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Flex items calculation test</title>
    <meta name="description" content="This is a description.">
    <style>
      body {
        height: 300vh;
        display: flex;
        align-items: center;
        padding: 0;
        margin: 0;
      }

      .box {
        border: 2px dotted rgb(96 139 168);
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        height: 600px;
        padding: 16px;
      }
      .box div {
        background-color: rgb(96 139 168 / 0.2);
        border: 2px solid rgb(96 139 168);
        border-radius: 5px;
        padding: 20px;
        margin: 8px 0;
      }
      .box .stretch {
        align-self: stretch;
      }
      .box .selected {
        align-self: center;
      }
    </style>
  </head>
  <body>
    <div class="box">
      <div>One</div>
      <div class="selected">Two</div>
      <div class="stretch">Three</div>
      <div>Four</div>
      <div>Five</div>
      <div>Six</div>
      <div class="selected">Seven</div>
      <div class="selected">Eight</div>
      <div>Nine</div>
      <div>Ten</div>
      <div>Eleven</div>
      <div class="selected">Twelve</div>
      <div class="selected">Thirteen</div>
      <div>Fourteen</div>
      <div>Fifteen</div>
      <div>Sixteen</div>
      <div class="selected">Seventeen</div>
      <div class="selected">Eighteen</div>
      <div>Nineteen</div>
      <div>Twenty</div>
      <div>Twenty one</div>
      <div class="selected">Twenty two</div>
      <div class="selected">Twenty three</div>
      <div>Twenty four</div>
      <div>Twenty five</div>
      <div>Twenty six</div>
    </div>

    <script type="module">
      import { createFlexRowsReducer } from '../../src/reducers';

      function hightlightAllFlexRows(top, bottom) {
        const highlightArea = document.createElement('div');
        const { scrollLeft, scrollTop } = document.documentElement;

        let highlightTop = top;
        let highlightBottom = bottom;

        const style = {
          position: 'absolute',
          backgroundColor: 'rgb(145 231 197 / 20%)',
          border: '2px solid rgb(145 231 197)',
          left: `0px`,
          top: `${highlightTop + scrollTop}px`,
          width: `100%`,
          height: `${highlightBottom - highlightTop}px`,
        };

        requestAnimationFrame(() => {
          Object.assign(highlightArea.style, style);
          highlightArea.classList.add('flex-row-highlight-area');
          document.body.appendChild(highlightArea);
        });
      }

      function hightlightFlexRow(row) {
        const highlightArea = document.createElement('div');
        const { scrollLeft, scrollTop } = document.documentElement;

        let highlightTop = Infinity;
        let highlightRight = -Infinity;
        let highlightBottom = -Infinity;
        let highlightLeft = Infinity;

        for (let entry of row) {
          const { top, right, bottom, left } = entry.boundingClientRect;
          
          highlightTop = Math.min(highlightTop, top);
          highlightRight = Math.max(highlightRight, right);
          highlightBottom = Math.max(highlightBottom, bottom);
          highlightLeft = Math.min(highlightLeft, left);
        }

        const style = {
          position: 'absolute',
          backgroundColor: 'rgb(231 197 145 / 20%)',
          border: '2px solid rgb(254 202 91)',
          left: `${highlightLeft + scrollLeft}px`,
          top: `${highlightTop + scrollTop}px`,
          width: `${highlightRight - highlightLeft}px`,
          height: `${highlightBottom - highlightTop}px`,
        };

        requestAnimationFrame(() => {
          Object.assign(highlightArea.style, style);
          highlightArea.classList.add('flex-row-highlight-area');
          document.body.appendChild(highlightArea);
        });
      }

      function removeHeightlightFlexRows() {
        const highlightAreas = document.querySelectorAll('.flex-row-highlight-area');

        if (highlightAreas) {
          for (const highlightArea of highlightAreas) {
            highlightArea.remove();
          }
        }
      }

      const box = document.querySelector('.box');
      const notIntersectedFlexItemsReducer = createFlexRowsReducer();

      const observer = new IntersectionObserver(entries => {
        // console.log(getNotIntersectedFlexItems(entries));
        notIntersectedFlexItemsReducer.init(box, flexBoxInineSize, false, true);
        requestAnimationFrame(removeHeightlightFlexRows);

        for (const entry of entries) {
          notIntersectedFlexItemsReducer.exec(entry, entries);
        }

        const acc = notIntersectedFlexItemsReducer.getAccumulator();

        for (const row of acc.rows) {
          hightlightFlexRow(row);
        }

        hightlightAllFlexRows(acc.rowsTop, acc.rowsBottom);
      });

      let flexBoxInineSize = 0;

      const resizeObserver = new ResizeObserver((entries) => {
        flexBoxInineSize = entries[0].contentBoxSize[0].inlineSize;
      });

      addEventListener('scroll', () => {
        resizeObserver.disconnect();
        resizeObserver.observe(box, {box: 'content-box'});
        observer.disconnect();
        for (const item of box.children) {
          observer.observe(item);
        }
      });
    </script>

  </body>
</html>